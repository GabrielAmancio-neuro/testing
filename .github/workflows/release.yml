name: Release

on:
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Generate Changelog
        uses: github-changelog-generator/github-changelog-generator@v1.17.2
        with:
          future-release: ${{ github.ref }}
          since-tag: ${{ github.event.before }}
          output-file: CHANGELOG.md
      - name: Create release
        id: create_release
        uses: actions/create-release@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            $(cat CHANGELOG.md)
          draft: false
          prerelease: false
      - name: Send Notification to Google Chat
        uses: google-github-actions/chat@v1
        with:
          chat_webhook: ${{ secrets.WEBHOOK }}
          message: |
            A new release has been created!
            Release: ${{ github.ref }}
            Changelog: $(cat CHANGELOG.md)
      - name: Google Chat Notification
        run: |
            curl --location --request POST '${{ secrets.WEBHOOK }}' \
            --header 'Content-Type: application/json' \
            --data-raw '{
                "cards": [
                    {
                        "header": {
                            "title": "Release alert",
                        },
                        "sections": [
                            {
                                "widgets": [
                                    {
                                      "keyValue": {
                                            "topLabel": "Creator",
                                            "content": "${{ github.event.push.pusher.name }}"
                                        },
                                    },
                                    {
                                      "keyValue": {
                                            "topLabel": "Version",
                                            "content": "${{ github.ref }}"
                                        }
                                    },
                                    {
                                      "keyValue": {
                                            "topLabel": "Body",
                                            "content": "- ${{ steps.build_changelog.outputs.changelog }}"
                                        }
                                    },
                                    {
                                        "buttons": [
                                            {
                                                "textButton": {
                                                    "text": "OPEN RELEASE",
                                                    "onClick": {
                                                        "openLink": {
                                                            "url": "${{ steps.create_release.outputs.html_url }}"
                                                        }
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }'